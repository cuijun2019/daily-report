<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width" />
<title>日志统计信息</title>
<!--1、Jquery组件引用-->
<script src="modules/geogis/js/jquery-1.12.4.min.js"></script>
<!--2、bootstrap组件引用-->
<script src="modules/geogis/bootstrap/js/bootstrap.js"></script>
<link href="modules/geogis/bootstrap-table-develop/docs/assets/bootstrap/css/bootstrap.css" rel="stylesheet" />
<script type="text/javascript" src="modules/geogis/Bootstrap-3-Typeahead-master/bootstrap3-typeahead.js"></script>
<!--3、bootstrap table组件以及中文包的引用-->
<script src="modules/geogis/bootstrap-table-develop/src/bootstrap-table.js"></script>
<link href="modules/geogis/bootstrap-table-develop/src/bootstrap-table.css" rel="stylesheet" />
<script src="modules/geogis/bootstrap-table-develop/src/locale/bootstrap-table-zh-CN.js"></script>
<!---4、页面Js文件的引用
<script src="~/Scripts/Home/Index.js"></script>     -->
<script src="modules/geogis/bootstrap-table-develop/src/extensions/export/bootstrap-table-export.js"></script>
<script src="modules/geogis/tableExport.jquery.plugin-master/tableExport.js"></script>

<link type="text/css" rel="stylesheet" href="modules/geogis/bootstrap-fileinput-master/css/fileinput.css" />
<script type="text/javascript" src="modules/geogis/bootstrap-fileinput-master/js/fileinput.js"></script>
<script type="text/javascript" src="modules/geogis/bootstrap-fileinput-master/js/locales/zh.js"></script>

<link rel="stylesheet" href="modules/geogis/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css" />
<script type="text/javascript" src="modules/geogis/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.min.js"></script>
<script type="text/javascript" src="modules/geogis/bootstrap-datetimepicker-master/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
<script type="text/javascript">
$(function () {
    //1.初始化Table
    var oTable = new TableInit();
    oTable.Init();

    //2.初始化Button的点击事件
    var oButtonInit = new ButtonInit();
    oButtonInit.Init();

    $('#tb_statisticsInfo').bootstrapTable('hideColumn', 'id');
    $('#tb_statisticsInfo').bootstrapTable('hideColumn', 'workDate');

    $('#employee').typeahead({
        source: function (query, process) {
            //query是输入的值
            $.post("/modules/project/queryEmployeeInfo?random=" + Math.random(), { name: query }, function (datas) {
                var array = [];
                for (var i = 0; i < datas.length; i++) {
                    var data = datas[i];
                    array.push(data.employee);
                }
                array = unique(array);
                process(array);
            });
        },
        items : "all",
        updater : function(item) {
            return item;
        },
        afterSelect: function (item) {
        },
        delay: 500
    });

    $('#startDate').datetimepicker({
        language:  'zh-CN',
        minView : "month",
        format : 'yyyy-mm-dd',
        clearBtn: true,
        autoclose : 1
    });
    $('#endDate').datetimepicker({
        language:  'zh-CN',
        minView : "month",
        format : 'yyyy-mm-dd',
        clearBtn: true,
        autoclose : 1
    });

    $("#all").click(function() {
        $("#allDiv").css("border-color", "red");
        $("#payDiv").css("border-color", "#CCCCCC");
        $("#unpaidDiv").css("border-color", "#CCCCCC");
        $("#payCondition").val("0");
        $('#tb_statisticsInfo').bootstrapTable('refresh');
    });
    $("#pay").click(function() {
        $("#allDiv").css("border-color", "#CCCCCC");
        $("#payDiv").css("border-color", "red");
        $("#unpaidDiv").css("border-color", "#CCCCCC");
        $("#payCondition").val("1");
        $('#tb_statisticsInfo').bootstrapTable('refresh');
    });
    $("#unpaid").click(function() {
        $("#allDiv").css("border-color", "#CCCCCC");
        $("#payDiv").css("border-color", "#CCCCCC");
        $("#unpaidDiv").css("border-color", "red");
        $("#payCondition").val("2");
        $('#tb_statisticsInfo').bootstrapTable('refresh');
    });
});

//数组去重
function unique(arr){
    var new_arr=[];
    for(var i=0;i<arr.length;i++) {
        var items=arr[i];
        if($.inArray(items,new_arr)==-1) {
            new_arr.push(items);
        }
    }
    return new_arr;
}

function changeColor(i) {
    $("#tr_" + i).css("background-color", "#F5F5F5");
}

function changeOutColor(i, color) {
    $("#tr_" + i).css("background-color", color);
}

var TableInit = function () {
    var oTableInit = new Object();
    //初始化Table
    oTableInit.Init = function () {
        $('#tb_statisticsInfo').bootstrapTable({
            url: "/modules/project/queryStatisticsInfo",
            method: 'post', //请求方式（*）
            contentType : "application/x-www-form-urlencoded",
            toolbar: '#toolbar', //工具按钮用哪个容器
            striped: true, //是否显示行间隔色
            cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true, //是否显示分页（*）
            sortable: false, //是否启用排序
            sortOrder: "asc", //排序方式
            queryParams: oTableInit.queryParams,//传递参数（*）
            sidePagination: "server", //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1, //初始化加载第一页，默认第一页
            pageSize: 10, //每页的记录行数（*）
            pageList: [10, 25, 50, 100], //可供选择的每页的行数（*）
//                    search: true, //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
            strictSearch: true,
            showColumns: true, //是否显示所有的列
            showRefresh: true, //是否显示刷新按钮
            minimumCountColumns: 2, //最少允许的列数
            clickToSelect: true, //是否启用点击选中行
            showExport: true, //是否显示导出
            exportDataType: "basic", //basic', 'all', 'selected'.
//            height: 500, //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
            uniqueId: "ID", //每一行的唯一标识，一般为主键列
            showToggle:true, //是否显示详细视图和列表视图的切换按钮
            cardView: false, //是否显示详细视图
            detailView: false, //是否显示父子表
            paginationLoop: false,//第一页不能点击上一页，最后一页不能点击下一页
            columns: [{
                checkbox: true
            }, {
                field: 'id',
                title: '主键'
            }, {
                field: 'employeeCode',
                title: '员工工号'
            }, {
                field: 'employee',
                title: '员工姓名'
            }, {
                field: 'workDate',
                title: '工作日'
            }, {
                field: 'remark',
                title: '日志提交详情',
                formatter: function(value,row,index){
                    var remark = row.remark;
                    var subRemark = "";
                    if (row.notLogCount != 0) {
                        subRemark = remark.substring(0, remark.indexOf("，具体")) + "...";
                    } else {
                        subRemark = remark;
                    }
                    return subRemark + "&nbsp;&nbsp;&nbsp;&nbsp;<a style='color:#428BCA;cursor:pointer; text-decoration:none;' data-toggle='modal' data-target='#myModal' onclick='detail(\""+remark+"\",\""+ row.workDate+"\",\""+ row.notLogCount + "\")'>详情</a>";
                }
            }]
        });
    };

    //得到查询的参数
    oTableInit.queryParams = function (params) {
        var temp = { //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
            limit: params.limit, //页面大小
            offset: params.offset, //页码
            employee: $("#employee").val(),
            startDate: $("#startDate").val(),
            endDate: $("#endDate").val(),
            payCondition: $("#payCondition").val()
        };
        return temp;
    };
    return oTableInit;
};

function detail(remark, workDates, notLogCount) {
    var str = "";
    if (workDates != "") {
        var workDate = [];
        str = '<table style="border:1px solid #DDDDDD;">';
        str += '	<tr style="border:1px solid #DDDDDD;height:44px;">';
        str += '		<td style="border:1px solid #DDDDDD;width:150px;font-weight:bold;padding-left:10px;">日志时间';
        str += '		</td>';
        str += '		<td style="border:1px solid #DDDDDD;width:150px;font-weight:bold;padding-left:10px;">是否填写日志';
        str += '		</td>';
        str += '	</tr>';
        remark = remark.substring(remark.indexOf("是") + 1, remark.length - 1);
        for (var i = 0; i < workDates.split(",").length; i++) {
            workDate = workDates.split(",");
            if(isFreeday(new Date(workDate[i])) && remark.indexOf(workDate[i]) != -1){
                continue;
            }
            if (i % 2 == 0) {
                str += '	<tr id="tr_' + i + '" style="background-color:#F9F9F9;border:1px solid #DDDDDD;height:40px;" onmouseover="changeColor(' + i + ')" onmouseout="changeOutColor(' + i + ',\'#F9F9F9\')">';
            } else {
                str += '	<tr id="tr_' + i + '" style="background-color:#FFFFFF;border:1px solid #DDDDDD;height:40px;" onmouseover="changeColor(' + i + ')" onmouseout="changeOutColor(' + i + ',\'#FFFFFF\')">';
            }
            str += '		<td id style="border:1px solid #DDDDDD;width:150px;padding-left:10px;">';
            //str += '			' + workDate[i];
            if(isFreeday(new Date(workDate[i])) && remark.indexOf(workDate[i]) == -1){
                str += '			' + workDate[i];
            }
            if(!(isFreeday(new Date(workDate[i])))){
                str += '			' + workDate[i];
            }
            str += '		</td>';
            str += '		<td style="border:1px solid #DDDDDD;width:150px;text-align:center;">';
            if (remark.indexOf(workDate[i]) == -1 || notLogCount == 0) {
                str += '			√';
            }
            str += '		</td>';
            str += '	</tr>';
        }
        str += '</table>';
    }
    $("#remark").html(str);
}

var ButtonInit = function () {
    var oInit = new Object();
    var postdata = {};

    oInit.Init = function () {
        //初始化页面上面的按钮事件
        $("#btn_query").click(function() {
            $('#tb_statisticsInfo').bootstrapTable('refresh',{query:{offset:0}});
        });
        $("#btn_reset").click(function() {
            $("#employee").val("");
            $("#startDate").val("");
            $("#endDate").val("");
        });
        $("#btn_export").click(function() {
            var payCondition = $("#payCondition").val();
            var employee = $("#employee").val();
            var timeStart = $("#startDate").val();
            var timeEnd = $("#endDate").val();
            var rows = $("#tb_statisticsInfo").bootstrapTable('getSelections');
            var employeeCodes = "";
            if (rows.length > 0) {
                for(var i=0;i<rows.length;i++){
                    employeeCodes += "," + rows[i].employeeCode;
                }
                employeeCodes = employeeCodes.substring(1);
            }
            $('#down_temp_iframe').attr('src','/modules/project/exportStatisticsData?type=xls&payCondition=' + payCondition + '&employee='+employee+'&timeStart='+timeStart+'&timeEnd='+timeEnd + '&employeeCodes=' + employeeCodes);
        });
    };
    return oInit;
};
function isFreeday(date){
    if(date.getDay()==0 || date.getDay()==6){
        return true;
    }
    return false;
}
</script>
</head>
<body>
<iframe id="down_temp_iframe" style="display: none;"></iframe>
<div class="panel-body" style="padding-bottom:0px;">
    <div class="panel panel-default">
        <div class="panel-heading">查询条件</div>
        <div class="panel-body">
            <form id="formSearch" class="form-horizontal">
                <div id="allDiv" style="background-color:white;width:60px;border:1px solid;padding-top:5px;padding-bottom:5px;border-color:red;" class="col-xs-1">
                    <a id="all" style="padding-top:5px;padding-bottom:5px;color:#666666;text-decoration: none;cursor:pointer;">全部</a>
                </div>
                <div style="width:1px;" class="col-xs-1">
                </div>
                <div id="payDiv" style="background-color:white;width:60px;border:1px solid;padding-top:5px;padding-bottom:5px;border-color:#CCCCCC;" class="col-xs-1">
                    <a id="pay" style="padding-top:5px;padding-bottom:5px;color:#666666;text-decoration: none;cursor:pointer;">已交</a>
                </div>
                <div style="width:1px;" class="col-xs-1">
                </div>
                <div id="unpaidDiv" style="background-color:white;width:60px;border:1px solid;padding-top:5px;padding-bottom:5px;border-color:#CCCCCC;" class="col-xs-1">
                    <a id="unpaid" style="padding-top:5px;padding-bottom:5px;color:#666666;text-decoration: none;cursor:pointer;">未交</a>
                </div>
                <div style="width:1px;" class="col-xs-1">
                </div>
                <input type="hidden" id="payCondition" />
                <div class="col-xs-2">
                    <input type="text" class="form-control" id="employee" data-provide="typeahead" data-source="" placeholder="请输入员工姓名" onfocus="this.placeholder=''" onblur="this.placeholder='请输入员工姓名'" />
                </div>
                <div class="col-xs-2">
                    <input type="text" class="form-control" id="startDate" placeholder="请输入开始时间" onfocus="this.placeholder=''" onblur="this.placeholder='请输入开始时间'" />
                </div>
                <div class="col-xs-2">
                    <input type="text" class="form-control" id="endDate" placeholder="请输入结束时间" onfocus="this.placeholder=''" onblur="this.placeholder='请输入结束时间'" />
                </div>
                <div class="col-xs-2">
                    <button type="button" id="btn_query" class="btn btn-primary btn-sm">查询</button>
                    <button type="button" class="btn btn-sm" id="btn_reset">重置</button>
                </div>
            </form>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">日志统计信息</div>
        <div id="toolbar" class="btn-group">
            <button id="btn_export" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-download" aria-hidden="true"></span>导出
            </button>
        </div>
        <table id="tb_statisticsInfo"></table>
    </div>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div style="width:500px;" class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    日志提交详情
                </h4>
            </div>
            <div class="modal-body">
                <div style="height:400px;overflow:auto" id="remark"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">关闭
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
</body>
</html>
