<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>项目信息</title>
        <!--1、Jquery组件引用-->
        <script src="modules/geogis/js/jquery-1.12.4.min.js"></script>
        <!--2、bootstrap组件引用-->
        <script src="modules/geogis/bootstrap/js/bootstrap.js"></script>
        <link href="modules/geogis/bootstrap-table-develop/docs/assets/bootstrap/css/bootstrap.css" rel="stylesheet" />
        <script type="text/javascript" src="modules/geogis/Bootstrap-3-Typeahead-master/bootstrap3-typeahead.js"></script>
        <!--3、bootstrap table组件以及中文包的引用-->
        <script src="modules/geogis/bootstrap-table-develop/src/bootstrap-table.js"></script>
        <link href="modules/geogis/bootstrap-table-develop/src/bootstrap-table.css" rel="stylesheet" />
        <script src="modules/geogis/bootstrap-table-develop/src/locale/bootstrap-table-zh-CN.js"></script>
        <!---4、页面Js文件的引用
        <script src="~/Scripts/Home/Index.js"></script>     -->
        <script src="modules/geogis/bootstrap-table-develop/src/extensions/export/bootstrap-table-export.js"></script>
        <script src="modules/geogis/tableExport.jquery.plugin-master/tableExport.js"></script>

        <link type="text/css" rel="stylesheet" href="modules/geogis/bootstrap-fileinput-master/css/fileinput.css" />
        <script type="text/javascript" src="modules/geogis/bootstrap-fileinput-master/js/fileinput.js"></script>
        <script type="text/javascript" src="modules/geogis/bootstrap-fileinput-master/js/locales/zh.js"></script>

        <link rel="stylesheet" href="modules/geogis/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css" />
        <script type="text/javascript" src="modules/geogis/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.min.js"></script>
        <script type="text/javascript" src="modules/geogis/bootstrap-datetimepicker-master/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>

        <script src="modules/geogis/layer/layer.js" type="text/javascript"></script>
<script type="text/javascript">
$(function () {
    //1.初始化Table
    var oTable = new TableInit();
    oTable.Init();

    //2.初始化Button的点击事件
    var oButtonInit = new ButtonInit();
    oButtonInit.Init();

    $('#tb_projectInfo').bootstrapTable('hideColumn', 'id');

    //0.初始化fileinput
    var oFileInput = new FileInput();
    oFileInput.Init("fileUpload", "/modules/project/importContractReview");

    $("#saveProjectInfo").click(function() {
        var id = $('#id').val();
        var projectCode = $('#addProjectCode').val();
        var projectName = $('#addProjectName').val();
        var reporter = $('#addReporter').val();
        var contractAmount = $('#addContractAmount').val();
        var contractTime = $('#addContractTime').val();
        var marketLeader = $('#addMarketLeader').val();
        var startTime = $('#addStartTime').val();
        var endTime = $('#addEndTime').val();
        if (projectCode=="") {
            layer.msg("项目编码不能为空");
            return;
        }
        if (projectName=="") {
            layer.msg("项目名称不能为空");
            return;
        }
        if (reporter=="") {
            layer.msg("项目经理不能为空");
            return;
        }
        if(isNaN(contractAmount)) {
            layer.msg("合同签订金额不是数值");
            return;
        }

        $.ajax({
            url : "/modules/project/saveOrUpdateProject?random=" + Math.random(),
            type : "post",
            data : {
                id : id,
                projectCode : projectCode,
                projectName : projectName,
                reporter : reporter,
                contractAmount : contractAmount,
                contractTime : contractTime,
                marketLeader : marketLeader,
                startTime : startTime,
                endTime : endTime
            },
            async : true,
            cache : false,
            dataType : 'json',
            success : function(data) {
                layer.msg(data.msg);
                $('#addProjectCode').val("");
                $('#addProjectName').val("");
                $('#addReporter').val("");
                $('#addContractAmount').val("");
                $('#addContractTime').val("");
                $('#addMarketLeader').val("");
                $('#addStartTime').val("");
                $('#addEndTime').val("");
                $('#addModal').modal('hide');
                $('#tb_projectInfo').bootstrapTable('refresh');
            }
        });
    });

    $('#projectName').typeahead({
        source: function (query, process) {
            //query是输入的值
            $.post("/modules/project/queryContractReview?random=" + Math.random(), { name: query }, function (datas) {
                var array = [];
                for (var i = 0; i < datas.length; i++) {
                    var data = datas[i];
                    array.push(data.projectName);
                }
                array = unique(array);
                process(array);
            });
        },
        items : "all",
        updater : function(item) {
            return item;
        },
        afterSelect: function (item) {
        },
        delay: 500
    });

    $('#reporter').typeahead({
        source: function (query, process) {
            //query是输入的值
            $.post("/modules/project/queryEmployeeInfo?random=" + Math.random(), { name: query }, function (datas) {
                var array = [];
                for (var i = 0; i < datas.length; i++) {
                    var data = datas[i];
                    array.push(data.employee);
                }
                array = unique(array);
                process(array);
            });
        },
        items : "all",
        updater : function(item) {
            return item;
        },
        afterSelect: function (item) {
        },
        delay: 500
    });

    $('#addContractTime').datetimepicker({
        language:  'zh-CN',
        minView : "month",
        format : 'yyyy-mm-dd',
        autoclose : 1
    });
    $('#addStartTime').datetimepicker({
        language:  'zh-CN',
        minView : "month",
        format : 'yyyy-mm-dd',
        autoclose : 1
    });
    $('#addEndTime').datetimepicker({
        language:  'zh-CN',
        minView : "month",
        format : 'yyyy-mm-dd',
        autoclose : 1
    });
});

//数组去重
function unique(arr){
    var new_arr=[];
    for(var i=0;i<arr.length;i++) {
        var items=arr[i];
        if($.inArray(items,new_arr)==-1) {
            new_arr.push(items);
        }
    }
    return new_arr;
}

//初始化fileinput
var FileInput = function () {
    var oFile = new Object();
    //初始化fileinput控件（第一次初始化）
    oFile.Init = function(ctrlName, uploadUrl) {
        var control = $('#' + ctrlName);
        //初始化上传控件的样式
        control.fileinput({
            language: 'zh', //设置语言
            uploadUrl: uploadUrl, //上传的地址
            allowedFileExtensions: ['xls', 'xlsx'],//接收的文件后缀
            showUpload: true, //是否显示上传按钮
            showCaption: false,//是否显示标题
            browseClass: "btn btn-primary", //按钮样式
            //dropZoneEnabled: false,//是否显示拖拽区域
            //minImageWidth: 50, //图片的最小宽度
            //minImageHeight: 50,//图片的最小高度
            //maxImageWidth: 1000,//图片的最大宽度
            //maxImageHeight: 1000,//图片的最大高度
            //maxFileSize: 0,//单位为kb，如果为0表示不限制文件大小
            //minFileCount: 0,
            maxFileCount: 1, //表示允许同时上传的最大文件个数
            enctype: 'multipart/form-data',
            validateInitialCount:true,
            previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
            msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！"
        });
        //导入文件上传完成之后的事件
        $("#fileUpload").on("fileuploaded", function (event, data, previewId, index) {
            if (data.response.msg.indexOf("导入失败") != -1) {
                layer.msg(data.response.msg);
                return;
            }
            $("#myModal").modal("hide");
            //1.初始化表格
            var oTable = new TableInit();
            oTable.Init(data);
            $("#tb_projectInfo").show();
            $('#tb_projectInfo').bootstrapTable('refresh');
        });
    }
    return oFile;
};


var TableInit = function () {
    var oTableInit = new Object();
    //初始化Table
    oTableInit.Init = function () {
        $('#tb_projectInfo').bootstrapTable({
            url: "/modules/project/queryContractReviewInfo",
            method: 'post', //请求方式（*）
            contentType : "application/x-www-form-urlencoded",
            toolbar: '#toolbar', //工具按钮用哪个容器
            striped: true, //是否显示行间隔色
            cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true, //是否显示分页（*）
            sortable: false, //是否启用排序
            sortOrder: "asc", //排序方式
            queryParams: oTableInit.queryParams,//传递参数（*）
            sidePagination: "server", //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1, //初始化加载第一页，默认第一页
            pageSize: 10, //每页的记录行数（*）
            pageList: [10, 25, 50, 100], //可供选择的每页的行数（*）
//            search: true, //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
            strictSearch: true,
            showColumns: true, //是否显示所有的列
            showRefresh: true, //是否显示刷新按钮
            minimumCountColumns: 2, //最少允许的列数
            clickToSelect: true, //是否启用点击选中行
            showExport: true, //是否显示导出
            exportDataType: "basic", //basic', 'all', 'selected'.
            height: 500, //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
            uniqueId: "ID", //每一行的唯一标识，一般为主键列
            showToggle:true, //是否显示详细视图和列表视图的切换按钮
            cardView: false, //是否显示详细视图
            detailView: false, //是否显示父子表
            paginationLoop: false,//第一页不能点击上一页，最后一页不能点击下一页
            columns: [{
                checkbox: true
            }, {
                field: 'id',
                title: '主键'
            }, {
                field: 'projectCode',
                title: '<span style="width:115px;display:inline-block;">项目编码</span>'
            }, {
                field: 'projectName',
                title: '<span style="width:450px;display:inline-block;">项目名称</span>'
            }, {
                field: 'reporter',
                title: '<span style="width:80px;display:inline-block;">项目经理</span>'
            }, {
                field: 'contractAmount',
                title: '<span style="width:90px;display:inline-block;">合同签订金额</span>'
            }, {
                field: 'contractTime',
                title: '<span style="width:100px;display:inline-block;">合同签订时间</span>'
            }, {
                field: 'marketLeader',
                title: '<span style="width:80px;display:inline-block;">市场负责人</span>'
            }, {
                field: 'startTime',
                title: '<span style="width:100px;display:inline-block;">项目开始时间</span>'
            }, {
                field: 'endTime',
                title: '<span style="width:100px;display:inline-block;">项目结束时间</span>'
            }]
        });
    };

    //得到查询的参数
    oTableInit.queryParams = function (params) {
        var temp = { //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
            limit: params.limit, //页面大小
            offset: params.offset, //页码
            projectName: $("#projectName").val(),
            reporter: $("#reporter").val()
        };
        return temp;
    };
    return oTableInit;
};


var ButtonInit = function () {
    var oInit = new Object();
    var postdata = {};

    oInit.Init = function () {
        //初始化页面上面的按钮事件
        $("#btn_query").click(function() {
            $('#tb_projectInfo').bootstrapTable('refresh',{query:{offset:0}});
        });
        $("#btn_reset").click(function() {
            $("#projectName").val("");
            $("#reporter").val("");
        });
        $("#btn_export").click(function() {
            var projectName = $("#projectName").val();
            var reporter = $("#reporter").val();
            var rows = $("#tb_projectInfo").bootstrapTable('getSelections');
            var ids = "";
            if (rows.length > 0) {
                for(var i=0;i<rows.length;i++){
                    ids += "," + rows[i].id;
                }
                ids = ids.substring(1);
            }
            $('#down_temp_iframe').attr('src','/modules/project/exportContractReviewData?type=xls&projectName='+projectName+'&reporter='+reporter+'&ids=' + ids);
        });
        $("#btn_remove").click(function() {
            var rows = $("#tb_projectInfo").bootstrapTable('getSelections');
            if (rows != null && rows != "") {
                layer.confirm('您确实要删除选定的记录吗？', {
                    btn: ['确定','取消'] //按钮
                }, function(){
                    var ids = "";
                    if (rows.length > 0) {
                        for(var i=0;i<rows.length;i++){
                            ids += "," + rows[i].id;
                        }
                        ids = ids.substring(1);
                    }
                    $.ajax({
                        url : "/modules/project/deleteProjectInfo?random=" + Math.random(),
                        type : "post",
                        data : {
                            ids : ids
                        },
                        async : true,
                        cache : false,
                        dataType : 'json',
                        success : function(data) {
                            layer.msg(data.msg);
                            $('#tb_projectInfo').bootstrapTable('refresh');
                        }
                    });
                }, function(){

                });
            } else {
                layer.msg("请选取要删除的数据！");
                return;
            }
        });
        $("#btn_add").click(function() {
            $('#id').val("");
            $('#addProjectCode').val("");
            $('#addProjectName').val("");
            $('#addReporter').val("");
            $('#addContractAmount').val("");
            $('#addContractTime').val("");
            $('#addMarketLeader').val("");
            $('#addStartTime').val("");
            $('#addEndTime').val("");
        });
        $("#btn_edit").click(function() {
            var rows = $("#tb_projectInfo").bootstrapTable('getSelections');
            if (rows != null && rows != "") {
                if (rows.length == 1) {
                    var row = rows[0];
                    $('#id').val(row.id);
                    $('#addProjectCode').val(row.projectCode);
                    $('#addProjectName').val(row.projectName);
                    $('#addReporter').val(row.reporter);
                    $('#addContractAmount').val(row.contractAmount);
                    $('#addContractTime').val(row.contractTime);
                    $('#addMarketLeader').val(row.marketLeader);
                    $('#addStartTime').val(row.startTime);
                    $('#addEndTime').val(row.endTime);
                    $('#addModal').modal('show');
                } else {
                    layer.msg("只能修改一条数据！");
                    return;
                }
            } else {
                layer.msg("请选取要修改的数据！");
                return;
            }
        });
    };
    return oInit;
};
</script>
</head>
<body>
<iframe id="down_temp_iframe" style="display: none;"></iframe>
<div class="panel-body" style="padding-bottom:0px;">
    <div class="panel panel-default">
        <div class="panel-heading">查询条件</div>
        <div class="panel-body">
            <form id="formSearch" class="form-horizontal">
                <div class="col-xs-2">
                    <input type="text" class="form-control" id="projectName" data-provide="typeahead" data-source="" placeholder="请输入项目名称" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目名称'" />
                </div>
                <div class="col-xs-2">
                    <input type="text" class="form-control" id="reporter" data-provide="typeahead" data-source="" placeholder="请输入项目经理" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目经理'" />
                </div>
                <div class="col-xs-2">
                    <button type="button" id="btn_query" class="btn btn-primary btn-sm">查询</button>
                    <button type="button" class="btn btn-sm" id="btn_reset">重置</button>
                </div>
            </form>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">项目信息</div>
        <div id="toolbar" class="btn-group">
            <button id="btn_export" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-download" aria-hidden="true"></span>导出
            </button>
            <!--<button id="btn_import" type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">
                <span class="glyphicon glyphicon-upload" aria-hidden="true"></span>导入
            </button>
            <button id="btn_add" type="button" class="btn btn-default" data-toggle="modal" data-target="#addModal">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>添加
            </button>
            <button id="btn_edit" type="button" class="btn btn-default" data-toggle="modal" data-target="#editModal">
                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑
            </button>
            <button id="btn_remove" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>删除
            </button>-->
        </div>
        <table id="tb_projectInfo"></table>
    </div>
</div>

<form>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title" id="myModalLabel">请选择Excel文件</h4>
                </div>
                <div class="modal-body">
                    <a href="project_template.xls" class="form-control" style="border:none;">下载导入模板</a>
                    <input type="file" name="fileUpload" id="fileUpload" class="file-loading" />
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="addModalLabel">编辑</h4>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="id"/>
                    <input type="text" class="form-control" id="addProjectCode" placeholder="请输入项目编码" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目编码'" />
                    <br />
                    <input type="text" class="form-control" id="addProjectName" placeholder="请输入项目名称" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目名称'" />
                    <br />
                    <input type="text" class="form-control" id="addReporter" placeholder="请输入项目经理" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目经理'" />
                    <br />
                    <input type="text" class="form-control" id="addContractAmount" placeholder="请输入合同签订金额" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入合同签订金额'" />
                    <br />
                    <input type="text" class="form-control" id="addContractTime" placeholder="请输入合同签订时间" onfocus="this.placeholder=''" onblur="this.placeholder='请输入合同签订时间'" />
                    <br />
                    <input type="text" class="form-control" id="addMarketLeader" placeholder="请输入市场负责人" autocomplete="off" onfocus="this.placeholder=''" onblur="this.placeholder='请输入市场负责人'" />
                    <br />
                    <input type="text" class="form-control" id="addStartTime" placeholder="请输入项目开始时间" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目开始时间'" />
                    <br />
                    <input type="text" class="form-control" id="addEndTime" placeholder="请输入项目结束时间" onfocus="this.placeholder=''" onblur="this.placeholder='请输入项目结束时间'" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="glyphicon glyphicon-remove btn btn-default btn-sm" data-dismiss="modal">关闭</button>
                <button type="button" id="saveProjectInfo" class="glyphicon glyphicon-floppy-disk btn btn-primary btn-sm">保存</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
</body>
</html>
